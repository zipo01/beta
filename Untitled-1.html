<!DOCTYPE html>
<html lang="th">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Admin Panel</title>
 <link rel="stylesheet" href="css/all.css"> <!-- เชื่อมโยงไปยังไฟล์ CSS เดิมของคุณ -->
 
</head>
<body>

 <!-- Navbar (จากงานเก่า - ลบปุ่มค้นหาออก) -->
 <div class="navbar">
  <button class="menu-button" onclick="toggleMenu()">☰ เมนู</button>
  <a href="index.html" class="logo">BETA</a>
 </div>

 <!-- Dropdown Menu (จากงานเก่า) -->
 <div id="dropdown" class="dropdown">
  <a href="index.html">หน้าหลัก</a>
  <a href="#about">เกี่ยวกับเรา</a>
  <a href="#services">บริการ</a>
  <a href="#contact">ติดต่อ</a>
 </div>

 <div class="admin-container">
  <h1>⚙️ แผงควบคุมผู้ดูแลระบบ ⚙️</h1>

  <div class="form-group">
   <label for="imageSelector">เลือกรหัสรูปภาพที่ต้องการแก้ไข:</label>
   <select id="imageSelector">
    <!-- Options จะถูกสร้างด้วย JavaScript -->
   </select>
   <button class="load-button" id="loadDataButton">โหลดข้อมูล</button>
   <button class="new-image-button" id="newImageButton">สร้างรูปภาพใหม่</button> <!-- New button -->
  </div>

  <div class="form-group">
   <label for="imageUrl">URL รูปภาพ:</label>
   <input type="text" id="imageUrl" placeholder="ใส่ URL รูปภาพ">
  </div>

  <!-- Removed Firebase Storage related upload section -->
  <div class="upload-section" style="display: none;">
    <label for="imageFileUpload">อัปโหลดรูปภาพใหม่:</label>
    <input type="file" id="imageFileUpload" accept="image/*">
    <button id="uploadFileButton">อัปโหลดรูปภาพ</button>
    <div id="uploadProgress" class="upload-progress"></div>
  </div>

  <div class="form-group">
   <label for="imageName">ชื่อรูปภาพ:</label>
   <input type="text" id="imageName" placeholder="ใส่ชื่อรูปภาพ">
  </div>

  <div class="form-group">
   <label for="imageCode">รหัสรูปภาพ:</label>
   <input type="text" id="imageCode" placeholder="รหัสรูปภาพ (เช่น 001)"> 
  </div>

  <div class="form-group">
   <label for="imageDescription">รายละเอียดรูปภาพ:</label>
   <textarea id="imageDescription" placeholder="ใส่รายละเอียดของรูปภาพ"></textarea>
  </div>

  <div class="form-group">
   <label for="imageTags">แท็ก (แต่ละแท็กขึ้นบรรทัดใหม่, ใช้ ✔️ หรือ ❌ นำหน้า):</label>
   <textarea id="imageTags" placeholder="ตัวอย่าง:&#10;✔️ แท็ก 1&#10;❌ แท็ก 2&#10;✔️ แท็ก 3"></textarea>
  </div>

  <div class="form-actions">
   <button id="saveChangesButton">บันทึกการเปลี่ยนแปลง</button>
   <button id="deleteImageButton" class="cancel-button">ลบรูปภาพนี้</button> <!-- Added Delete Button -->
  </div>

  <div class="message-area" id="messageArea">
   <!-- ข้อความแจ้งเตือนจะแสดงที่นี่ -->
  </div>
 </div>

 <script type="module">
  // Import the functions you need from the Firebase SDKs
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, collection, query, onSnapshot, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  // Removed Firebase Storage imports: import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

  // --- การตั้งค่า Firebase ของคุณเอง (สำหรับรันนอก Canvas หรือบน Neocities) ---
  const firebaseConfig = {
    apiKey: "AIzaSyBDdPmBy688gYV9eSSFYB-Cg_HMOOIVDgc",
    authDomain: "bata-ac6eb.firebaseapp.com",
    projectId: "bata-ac6eb",
    storageBucket: "bata-ac6eb.firebasestorage.app",
    messagingSenderId: "462889325937",
    appId: "1:462889325937:web:183f5a6a7738967f49d2d0",
    measurementId: "G-Z3FK4FW02Z" 
  };

  // กำหนด appId ด้วย projectId ของคุณ (สำหรับใช้ใน path ของ Firestore)
  const appId = firebaseConfig.projectId; 

  // initialAuthToken สามารถตั้งเป็น null ได้ หากคุณไม่ได้ใช้ระบบยืนยันตัวตนแบบ Custom Token
  const initialAuthToken = null; 

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  // Removed Firebase Storage initialization: const storage = getStorage(app); 
  console.log("Firebase initialized.");

  let userId = null; // Will be set after authentication
  let currentLoadedImageCode = null; // To keep track of the image code currently loaded in the form
  let allCachedImageData = {}; // Cache for all image data from Firestore snapshot

  // Default image data (used if Firestore is empty)
  // ข้อมูลเริ่มต้นนี้จะถูกใช้โดย initializeDataIfEmpty() เพื่อสร้างข้อมูลใน Firestore หากยังไม่มี
  const defaultImageData = {
    "001": {
        imageUrl: `https://placehold.co/500x500/cccccc/333333?text=รูปภาพ+001`, // Placeholder image
        imageName: `ชื่อภาพ 1`,
        imageCode: "001",
        description: `นี่คือรายละเอียดสำหรับรูปภาพ #001 สามารถแก้ไขได้จากหน้า Admin Panel นี้`,
        tags: [
            { text: 'แท็ก 1', status: '✔️' }, { text: 'แท็ก 2', status: '✔️' }, { text: 'แท็ก 3', status: '❌' },
            { text: 'แท็ก 4', status: '❌' }, { text: 'แท็ก 5', status: '❌' }, { text: 'แท็ก 6', status: '✔️' },
            { text: 'แท็ก 7', status: '❌' }, { text: 'แท็ก 8', status: '❌' }, { text: 'แท็ก 9', status: '✔️' },
            { text: 'แท็ก 10', status: '✔️' }, { text: 'แท็ก 11', status: '✔️' }
        ]
    }
  };

  // Authenticate user anonymously or with token
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      userId = user.uid;
      console.log("Authenticated with UID:", userId);
      // Once authenticated, initialize data if empty and set up real-time listener
      await initializeDataIfEmpty();
      setupRealtimeListenerForAdminPanel();
    } else {
      console.log("User not authenticated. Attempting sign-in...");
      try {
        if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
            console.log("Signed in with custom token.");
        } else {
            await signInAnonymously(auth);
            console.log("Signed in anonymously.");
        }
      } catch (error) {
        console.error("Firebase authentication error:", error);
        showMessage("เกิดข้อผิดพลาดในการยืนยันตัวตน กรุณาลองใหม่", "error");
      }
    }
  });

  // Function to initialize data in Firestore if collection is empty
  async function initializeDataIfEmpty() {
    console.log("Checking if Firestore collection is empty...");
    const imagesCollectionRef = collection(db, `artifacts/${appId}/public/data/images`);
    const q = query(imagesCollectionRef);
    const snapshot = await getDocs(q);

    if (snapshot.empty) {
      console.log("Firestore collection is empty. Initializing with default data...");
      // ใช้ defaultImageData ที่มีแค่ 1 รูปภาพ #001
      for (const code in defaultImageData) {
        const docRef = doc(db, `artifacts/${appId}/public/data/images`, code);
        await setDoc(docRef, defaultImageData[code]);
      }
      console.log("Default data initialized.");
    } else {
        console.log("Firestore collection is not empty. Skipping initialization.");
    }
  }

  // Real-time listener for all image data for the admin panel
  function setupRealtimeListenerForAdminPanel() {
    console.log("Setting up real-time listener for admin panel...");
    const imagesCollectionRef = collection(db, `artifacts/${appId}/public/data/images`);
    onSnapshot(imagesCollectionRef, (snapshot) => {
      const updatedImageData = {};
      snapshot.forEach(doc => {
        updatedImageData[doc.id] = doc.data();
      });
      allCachedImageData = updatedImageData; // Update the cache
      console.log("Admin Panel: Real-time data update received.", allCachedImageData);
      populateImageSelector(allCachedImageData); // Re-populate selector with latest data
      
      // If an image was loaded, try to reload its data to reflect changes
      if (currentLoadedImageCode && allCachedImageData[currentLoadedImageCode]) {
          loadDataIntoForm(allCachedImageData[currentLoadedImageCode]);
      } else if (imageSelector.options.length > 0) { // Check if there are any options left
          // If the previously loaded image was deleted or no image was loaded, load the first available one
          imageSelector.value = imageSelector.options[0].value; // Select the first option
          currentLoadedImageCode = imageSelector.options[0].value; // Update loaded code
          loadDataIntoForm(allCachedImageData[imageSelector.value]);
      } else {
          // If no images left, clear the form
          clearForm();
      }
    }, (error) => {
      console.error("Error listening to Firestore in Admin Panel:", error);
      showMessage("เกิดข้อผิดพลาดในการโหลดข้อมูลแบบเรียลไทม์", "error");
    });
  }

  // Helper function to parse tags from textarea string to array of objects
  function parseTagsFromTextarea(textareaValue) {
      return textareaValue.split('\n').map(line => {
          const trimmedLine = line.trim();
          if (trimmedLine.startsWith('✔️ ')) {
              return { status: '✔️', text: trimmedLine.substring(2).trim() };
          } else if (trimmedLine.startsWith('❌ ')) {
              return { status: '❌', text: trimmedLine.substring(2).trim() };
          } else {
              return { status: '', text: trimmedLine }; // If no mark, treat as plain tag
          }
      }).filter(tag => tag.text !== ''); // Filter out empty lines
  }

  // Elements
  const imageSelector = document.getElementById('imageSelector');
  const loadDataButton = document.getElementById('loadDataButton');
  const newImageButton = document.getElementById('newImageButton'); // New button
  const imageUrlInput = document.getElementById('imageUrl');
  const imageFileUpload = document.getElementById('imageFileUpload');
  const uploadFileButton = document.getElementById('uploadFileButton');
  const uploadProgressDiv = document.getElementById('uploadProgress');
  const imageNameInput = document.getElementById('imageName');
  const imageCodeInput = document.getElementById('imageCode');
  const imageDescriptionTextarea = document.getElementById('imageDescription');
  const imageTagsTextarea = document.getElementById('imageTags');
  const saveChangesButton = document.getElementById('saveChangesButton');
  const deleteImageButton = document.getElementById('deleteImageButton');
  const messageArea = document.getElementById('messageArea');

  // Populate image selector dropdown
  function populateImageSelector(allData) {
   console.log("Populating image selector with data:", allData);
   imageSelector.innerHTML = ''; // Clear existing options
   const sortedCodes = Object.keys(allData).sort((a, b) => parseInt(a) - parseInt(b));

   if (sortedCodes.length === 0) {
       const option = document.createElement('option');
       option.value = '';
       option.textContent = 'ไม่มีรูปภาพให้แก้ไข';
       imageSelector.appendChild(option);
       clearForm();
       console.log("No images found, selector cleared.");
       return;
   }

   sortedCodes.forEach(code => {
    const option = document.createElement('option');
    option.value = code;
    option.textContent = `รูปภาพ #${code} - ${allData[code].imageName}`;
    imageSelector.appendChild(option);
   });
   console.log("Image selector populated. Sorted codes:", sortedCodes);

   // Select the currently loaded image or the first one if none loaded
   if (currentLoadedImageCode && allData[currentLoadedImageCode]) {
       imageSelector.value = currentLoadedImageCode;
       console.log("Selecting previously loaded image:", currentLoadedImageCode);
   } else {
       imageSelector.value = sortedCodes[0];
       currentLoadedImageCode = sortedCodes[0]; // Set initial loaded code
       console.log("Selecting first image:", currentLoadedImageCode);
   }
   // No need to call loadDataIntoForm here, as onSnapshot will trigger it via currentLoadedImageCode check
  }

  // Load data into form fields
  function loadDataIntoForm(imageData) {
   console.log("Loading data into form:", imageData);
   if (!imageData) {
       clearForm();
       console.log("No image data provided, form cleared.");
       return;
   }
   currentLoadedImageCode = imageData.imageCode; // Update currently loaded code
   imageUrlInput.value = imageData.imageUrl;
   imageNameInput.value = imageData.imageName;
   imageCodeInput.value = imageData.imageCode;
   imageDescriptionTextarea.value = imageData.description;
   imageTagsTextarea.value = imageData.tags.map(tag => `${tag.status} ${tag.text}`).join('\n');
   
   // Enable fields if data is loaded
   imageUrlInput.disabled = false;
   imageNameInput.disabled = false;
   imageCodeInput.disabled = false;
   imageDescriptionTextarea.disabled = false;
   imageTagsTextarea.disabled = false;
   // uploadFileButton.disabled = false; // Removed Storage related enable/disable
   // imageFileUpload.disabled = false; // Removed Storage related enable/disable
   saveChangesButton.disabled = false;
   deleteImageButton.disabled = false;
   console.log("Form fields updated for image:", imageData.imageCode);
  }

  // Clear form fields and prepare for new image creation
  function clearForm() {
      imageUrlInput.value = '';
      imageNameInput.value = '';
      imageCodeInput.value = ''; // Clear code for new entry
      imageDescriptionTextarea.value = '';
      imageTagsTextarea.value = '';
      currentLoadedImageCode = null; // Indicate a new entry
      uploadProgressDiv.textContent = '';
      uploadProgressDiv.style.display = 'none';

      // Enable all fields for new entry
      imageUrlInput.disabled = false;
      imageNameInput.disabled = false;
      imageCodeInput.disabled = false; // User can type new code
      imageDescriptionTextarea.disabled = false;
      imageTagsTextarea.disabled = false;
      // uploadFileButton.disabled = false; // Removed Storage related enable/disable
      // imageFileUpload.disabled = false; // Removed Storage related enable/disable
      saveChangesButton.disabled = false;
      deleteImageButton.disabled = true; // Disable delete for new entry
      console.log("Form fields cleared for new image creation.");
      showMessage("กรอกข้อมูลเพื่อสร้างรูปภาพใหม่", "info");
  }

  // Generate a new unique image code
  function generateNewImageCode() {
      const existingCodes = Object.keys(allCachedImageData).map(code => parseInt(code));
      const maxCode = existingCodes.length > 0 ? Math.max(...existingCodes) : 0;
      const newCode = String(maxCode + 1).padStart(3, '0');
      return newCode;
  }

  // Removed Firebase Storage related function: handleImageUpload
  /*
  async function handleImageUpload() {
    // ... (removed content)
  }
  */

  // Save changes from form fields to Firestore
  async function saveChangesFromForm() {
   console.log("Attempting to save changes...");
   const selectedCodeAtLoad = currentLoadedImageCode; // Original code when loaded (null if new)
   let newCode = imageCodeInput.value.trim();

   if (!newCode) {
    // If creating a new image and code is empty, generate one
    if (selectedCodeAtLoad === null) {
        newCode = generateNewImageCode();
        imageCodeInput.value = newCode; // Update the input field with generated code
        showMessage(`รหัสรูปภาพถูกสร้างขึ้นอัตโนมัติ: #${newCode}`, "info");
    } else {
        // Should not happen if currentLoadedImageCode is not null, but as a fallback
        showMessage("รหัสรูปภาพต้องไม่ว่างเปล่า", "error");
        console.error("Image code is empty.");
        return;
    }
   }

   const currentFirestoreData = allCachedImageData;

   // Check if it's a new image or code has changed
   if (selectedCodeAtLoad === null || newCode !== selectedCodeAtLoad) {
    // If it's a new image OR code has changed for an existing one
    console.log(`Creating new image or changing code from '${selectedCodeAtLoad}' to '${newCode}'.`);
    if (currentFirestoreData[newCode]) {
        showMessage(`รหัสรูปภาพ '${newCode}' มีอยู่แล้ว กรุณาใช้รหัสอื่น`, "error");
        console.error(`New code '${newCode}' already exists.`);
        return;
    }

    let confirmAction = true;
    // Using custom modal for confirmation instead of window.confirm
    await new Promise(resolve => {
        const message = `คุณกำลังเปลี่ยนรหัสรูปภาพจาก '${selectedCodeAtLoad}' เป็น '${newCode}' การเปลี่ยนรหัสอาจทำให้ลิงก์ในหน้าหลักเสียได้หากไม่ได้อัปเดตตาม คุณแน่ใจหรือไม่?`;
        // Replace with your custom modal logic
        // For now, using a simple prompt for demonstration purposes in an environment where alert/confirm are restricted.
        // In a real app, you'd show a custom dialog.
        const userResponse = prompt(message + "\nพิมพ์ 'ใช่' เพื่อยืนยัน หรือ 'ไม่' เพื่อยกเลิก");
        confirmAction = (userResponse && userResponse.toLowerCase() === 'ใช่');
        resolve();
    });
    
    if (!confirmAction) {
        console.log("User cancelled action.");
        return; // User cancelled
    }

    try {
        // Create new document with new code
        const newDocRef = doc(db, `artifacts/${appId}/public/data/images`, newCode);
        await setDoc(newDocRef, {
            imageUrl: imageUrlInput.value || '', // Ensure URL is not undefined
            imageName: imageNameInput.value || 'ไม่มีชื่อ',
            imageCode: newCode,
            description: imageDescriptionTextarea.value || '',
            tags: parseTagsFromTextarea(imageTagsTextarea.value)
        });
        console.log(`Document created/updated with code: ${newCode}`);

        // If code changed for an existing document, delete the old one
        if (selectedCodeAtLoad !== null && newCode !== selectedCodeAtLoad && currentFirestoreData[selectedCodeAtLoad]) {
            const oldDocRef = doc(db, `artifacts/${appId}/public/data/images`, selectedCodeAtLoad);
            await deleteDoc(oldDocRef);
            console.log(`Old document '${selectedCodeAtLoad}' deleted.`);
        }
        showMessage(`บันทึกการเปลี่ยนแปลง/สร้างรูปภาพ #${newCode} เรียบร้อยแล้ว!`, "success");
        currentLoadedImageCode = newCode; // Update the loaded code
        // The onSnapshot listener will also re-populate the selector and load the new/updated image
    } catch (error) {
        console.error("Error saving changes/creating image in Firestore:", error);
        showMessage("เกิดข้อผิดพลาดในการบันทึกการเปลี่ยนแปลง/สร้างรูปภาพ", "error");
    }

   } else {
    // If code hasn't changed, just update the existing entry
    console.log("Code has not changed. Updating existing document.");
    try {
        const docRef = doc(db, `artifacts/${appId}/public/data/images`, newCode);
        await setDoc(docRef, {
            imageUrl: imageUrlInput.value || '',
            imageName: imageNameInput.value || 'ไม่มีชื่อ',
            imageCode: newCode,
            description: imageDescriptionTextarea.value || '',
            tags: parseTagsFromTextarea(imageTagsTextarea.value)
        });
        showMessage("บันทึกการเปลี่ยนแปลงเรียบร้อยแล้ว!", "success");
        console.log("Document updated successfully for code:", newCode);
    } catch (error) {
        console.error("Error saving changes to Firestore:", error);
        showMessage("เกิดข้อผิดพลาดในการบันทึกการเปลี่ยนแปลง", "error");
    }
   }
  }

  // Delete image from Firestore
  async function deleteImage() {
      console.log("Attempting to delete image...");
      const codeToDelete = imageCodeInput.value.trim();
      if (!codeToDelete || currentLoadedImageCode === null) { // Ensure an image is loaded
          showMessage("ไม่มีรูปภาพให้ลบ", "error");
          console.error("No image code to delete or no image loaded.");
          return;
      }

      let confirmDelete = false;
      await new Promise(resolve => {
          const message = `คุณแน่ใจหรือไม่ที่ต้องการลบรูปภาพ #${codeToDelete}? การดำเนินการนี้ไม่สามารถย้อนกลับได้`;
          // Replace with your custom modal logic
          const userResponse = prompt(message + "\nพิมพ์ 'ใช่' เพื่อยืนยัน หรือ 'ไม่' เพื่อยกเลิก");
          confirmDelete = (userResponse && userResponse.toLowerCase() === 'ใช่');
          resolve();
      });

      if (!confirmDelete) {
          console.log("User cancelled deletion.");
          return; // User cancelled
      }

      try {
          const docRef = doc(db, `artifacts/${appId}/public/data/images`, codeToDelete);
          await deleteDoc(docRef);
          showMessage(`รูปภาพ #${codeToDelete} ถูกลบเรียบร้อยแล้ว!`, "success");
          console.log(`Image #${codeToDelete} deleted from Firestore.`);
          // onSnapshot will handle clearing the form and re-populating the selector
      } catch (error) {
          console.error("Error deleting image from Firestore:", error);
          showMessage("เกิดข้อผิดพลาดในการลบรูปภาพ", "error");
      }
  }

  function showMessage(msg, type) {
   messageArea.textContent = msg;
   messageArea.style.display = 'block';
   messageArea.style.backgroundColor = type === "success" ? "#d4edda" : "#f8d7da";
   messageArea.style.color = type === "success" ? "#155724" : "#721c24";
   messageArea.style.borderColor = type === "success" ? "#c3e6cb" : "#f5c6cb";

   setTimeout(() => {
    messageArea.style.display = 'none';
   }, 3000); // ซ่อนข้อความหลังจาก 3 วินาที
  }

  // Event Listeners
  loadDataButton.addEventListener('click', () => {
      console.log("Load data button clicked.");
      const allData = allCachedImageData; // Use the cached data
      if (allData && imageSelector.value) {
          loadDataIntoForm(allData[imageSelector.value]);
      } else {
          showMessage("ไม่มีรูปภาพให้โหลด", "error");
      }
  });
  newImageButton.addEventListener('click', async () => { // Made async
      console.log("New Image button clicked. Creating new default entry.");
      const newCode = generateNewImageCode();
      const defaultNewImageData = {
          imageUrl: `https://placehold.co/500x500/cccccc/333333?text=รูปภาพ+${newCode}`, // Placeholder image
          imageName: `รูปภาพใหม่ #${newCode}`,
          imageCode: newCode,
          description: `รายละเอียดสำหรับรูปภาพใหม่ #${newCode}`,
          tags: [
              { text: 'แท็กใหม่', status: '✔️' },
              { text: 'ตัวอย่าง', status: '❌' }
          ]
      };

      try {
          const docRef = doc(db, `artifacts/${appId}/public/data/images`, newCode);
          await setDoc(docRef, defaultNewImageData);
          showMessage(`สร้างรูปภาพใหม่ #${newCode} เรียบร้อยแล้ว!`, "success");
          console.log(`New image #${newCode} created in Firestore.`);
          
          // After creation, load this new data into the form
          currentLoadedImageCode = newCode;
          loadDataIntoForm(defaultNewImageData);
          // The onSnapshot listener will also re-populate the selector
      } catch (error) {
          console.error("Error creating new image in Firestore:", error);
          showMessage("เกิดข้อผิดพลาดในการสร้างรูปภาพใหม่", "error");
      }
  });
  saveChangesButton.addEventListener('click', saveChangesFromForm);
  deleteImageButton.addEventListener('click', deleteImage);
  // Removed event listener for uploadFileButton: uploadFileButton.addEventListener('click', handleImageUpload);
  imageSelector.addEventListener('change', () => {
      console.log("Image selector changed.");
      const allData = allCachedImageData; // Use the cached data
      if (allData && imageSelector.value) {
          loadDataIntoForm(allData[imageSelector.value]);
      }
  });

  // --- Existing JavaScript functions (Dropdown Menu) ---
  function toggleMenu() {
   const dropdown = document.getElementById('dropdown');
   dropdown.style.display = (dropdown.style.display === 'block') ? 'none' : 'block';
  }

  window.onclick = function(event) {
   const button = document.querySelector('.menu-button');
   const dropdown = document.getElementById('dropdown');
   // ตรวจสอบว่าคลิกนอกปุ่มเมนูและนอก dropdown
   if (!button.contains(event.target) && !dropdown.contains(event.target)) {
    dropdown.style.display = 'none';
   }
  }

  // Initial load logic (moved to onAuthStateChanged)
  // This ensures Firebase is ready before attempting Firestore operations
 </script>

</body>
</html>
